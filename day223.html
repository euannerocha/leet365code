//updating with diffing

<!DOCTYPE html>
<html>
  <head>
    <title>Roet with Diffing</title>
    <style>
      .title {
        color: darkblue;
        font-family: Arial, sans-serif;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script>
      let oldVNode = null; // stores the previous virtual DOM

      function createElement(type, props, ...children) {
        props = props || {};
        props.children = children.length > 0 ? children : null;
        return { type, props };
      }

      function render(vnode, container) {
        if (oldVNode === null) {
          container.innerHTML = "";
          container.appendChild(createDom(vnode));
        } else {
          updateElement(container, vnode, oldVNode);
        }
        oldVNode = vnode;
      }

      function createDom(vnode) {
        if (typeof vnode === "string" || typeof vnode === "number") {
          return document.createTextNode(vnode);
        }

        if (typeof vnode.type === "function") {
          const defaultProps = vnode.type.defaultProps || {};
          const mergedProps = { ...defaultProps, ...vnode.props };
          return createDom(vnode.type(mergedProps));
        }

        const dom = document.createElement(vnode.type);

        if (vnode.props) {
          Object.keys(vnode.props).forEach(prop => {
            setProp(dom, prop, vnode.props[prop]);
          });
        }

        if (vnode.props && vnode.props.children) {
          vnode.props.children.forEach(child => dom.appendChild(createDom(child)));
        }

        return dom;
      }

      function setProp(dom, prop, value) {
        if (prop === "className") {
          dom.setAttribute("class", value);
        } else if (prop === "style" && typeof value === "object") {
          Object.assign(dom.style, value);
        } else if (prop !== "children") {
          dom[prop] = value;
        }
      }

      function updateElement(parent, newVNode, oldVNode, index = 0) {
        const existingDom = parent.childNodes[index];

        // remove
        if (newVNode === undefined) {
          parent.removeChild(existingDom);
          return;
        }

        // add
        if (oldVNode === undefined) {
          parent.appendChild(createDom(newVNode));
          return;
        }

        // replace
        if (changed(newVNode, oldVNode)) {
          parent.replaceChild(createDom(newVNode), existingDom);
          return;
        }

        // update props
        if (typeof newVNode.type === "string") {
          updateProps(existingDom, newVNode.props, oldVNode.props);

          // update children
          const newChildren = newVNode.props?.children || [];
          const oldChildren = oldVNode.props?.children || [];
          const maxLen = Math.max(newChildren.length, oldChildren.length);

          for (let i = 0; i < maxLen; i++) {
            updateElement(existingDom, newChildren[i], oldChildren[i], i);
          }
        }
      }

      function updateProps(dom, newProps, oldProps) {
        newProps = newProps || {};
        oldProps = oldProps || {};

        // set new or changed
        Object.keys(newProps).forEach(prop => {
          if (prop !== "children" && newProps[prop] !== oldProps[prop]) {
            setProp(dom, prop, newProps[prop]);
          }
        });

        // remove old
        Object.keys(oldProps).forEach(prop => {
          if (prop !== "children" && !(prop in newProps)) {
            dom.removeAttribute(prop);
          }
        });
      }

      function changed(node1, node2) {
        return (
          typeof node1 !== typeof node2 ||
          (typeof node1 === "string" && node1 !== node2) ||
          node1.type !== node2.type
        );
      }

      // Example Components
      function Button(props) {
        return createElement('button', { onclick: props.onClick }, props.label);
      }
      Button.defaultProps = {
        label: 'Click me',
        onClick: () => alert('Default click!')
      };

      function Box(props) {
        return createElement(
          'div',
          { style: { border: '1px solid black', padding: '10px' } },
          props.children
        );
      }

      function App(props) {
        return createElement(
          'div',
          null,
          createElement('h1', { className: 'title' }, `Hello ${props.name}`),
          createElement(Button, { label: props.buttonLabel }),
          createElement(Box, null, 'Hello inside box!')
        );
      }

      // Initial render
      render(createElement(App, { name: 'World', buttonLabel: 'Press me' }), document.getElementById('root'));

      // Update after 2 seconds
      setTimeout(() => {
        render(createElement(App, { name: 'Roet', buttonLabel: 'Updated!' }), document.getElementById('root'));
      }, 2000);
    </script>
  </body>
</html>